<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">

<title>b-causal.org - Inverse Probability of Treatment Weighting: A Practical Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">b-causal.org</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/go-bayes" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://qoto.org/(joseph_bulbulia?)" rel="" target=""><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Inverse Probability of Treatment Weighting: A Practical Guide</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Causal Inference</div>
                <div class="quarto-category">NZAVS</div>
                <div class="quarto-category">Methods</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Joseph Bulbulia </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">5/11/23</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-inverse-probability-of-treatment-weighting-iptw" id="toc-what-is-inverse-probability-of-treatment-weighting-iptw" class="nav-link active" data-scroll-target="#what-is-inverse-probability-of-treatment-weighting-iptw">What is Inverse Probability of Treatment Weighting (IPTW)?</a></li>
  <li><a href="#inverse-probability-of-treatment-weighting-iptw" id="toc-inverse-probability-of-treatment-weighting-iptw" class="nav-link" data-scroll-target="#inverse-probability-of-treatment-weighting-iptw">Inverse Probability of Treatment Weighting (IPTW)</a></li>
  <li><a href="#bias-in-observational-data-an-example" id="toc-bias-in-observational-data-an-example" class="nav-link" data-scroll-target="#bias-in-observational-data-an-example">Bias in Observational Data: An Example</a></li>
  <li><a href="#what-is-iptw" id="toc-what-is-iptw" class="nav-link" data-scroll-target="#what-is-iptw">What is IPTW?</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#step-1-understanding-iptw" id="toc-step-1-understanding-iptw" class="nav-link" data-scroll-target="#step-1-understanding-iptw">Step 1: Understanding IPTW</a></li>
  <li><a href="#step-2-propensity-scores" id="toc-step-2-propensity-scores" class="nav-link" data-scroll-target="#step-2-propensity-scores">Step 2: Propensity Scores</a></li>
  <li><a href="#step-3-average-treatment-effect-ate" id="toc-step-3-average-treatment-effect-ate" class="nav-link" data-scroll-target="#step-3-average-treatment-effect-ate">Step 3: Average Treatment Effect (ATE)</a></li>
  <li><a href="#step-4-creating-a-weighted-sample" id="toc-step-4-creating-a-weighted-sample" class="nav-link" data-scroll-target="#step-4-creating-a-weighted-sample">Step 4: Creating a Weighted Sample</a></li>
  <li><a href="#step-5-estimating-the-ate" id="toc-step-5-estimating-the-ate" class="nav-link" data-scroll-target="#step-5-estimating-the-ate">Step 5: Estimating the ATE</a></li>
  <li><a href="#step-5-estimating-the-ate-continued" id="toc-step-5-estimating-the-ate-continued" class="nav-link" data-scroll-target="#step-5-estimating-the-ate-continued">Step 5: Estimating the ATE (Continued)</a></li>
  <li><a href="#step-6-simulation" id="toc-step-6-simulation" class="nav-link" data-scroll-target="#step-6-simulation">Step 6: Simulation</a></li>
  <li><a href="#step-7-interpretation" id="toc-step-7-interpretation" class="nav-link" data-scroll-target="#step-7-interpretation">Step 7: Interpretation</a></li>
  <li><a href="#step-8-validation" id="toc-step-8-validation" class="nav-link" data-scroll-target="#step-8-validation">Step 8: Validation</a></li>
  <li><a href="#summary-1" id="toc-summary-1" class="nav-link" data-scroll-target="#summary-1">Summary</a>
  <ul class="collapse">
  <li><a href="#looking-ahead" id="toc-looking-ahead" class="nav-link" data-scroll-target="#looking-ahead">Looking ahead</a></li>
  </ul></li>
  <li><a href="#iptw-with-time-varying-treatments" id="toc-iptw-with-time-varying-treatments" class="nav-link" data-scroll-target="#iptw-with-time-varying-treatments">IPTW with Time-varying Treatments</a>
  <ul class="collapse">
  <li><a href="#checking-the-balance-of-covariates" id="toc-checking-the-balance-of-covariates" class="nav-link" data-scroll-target="#checking-the-balance-of-covariates">Checking the Balance of Covariates</a></li>
  <li><a href="#variance-estimation" id="toc-variance-estimation" class="nav-link" data-scroll-target="#variance-estimation">Variance Estimation</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="what-is-inverse-probability-of-treatment-weighting-iptw" class="level2">
<h2 class="anchored" data-anchor-id="what-is-inverse-probability-of-treatment-weighting-iptw">What is Inverse Probability of Treatment Weighting (IPTW)?</h2>
<p>Inverse Probability of Treatment Weighting (IPTW) is a method for estimating causal effects from observational data, using propensity scores to balance covariates between treated and untreated groups. This creates a pseudo-population where the probability of treatment assignment is independent of the observed covariates (gender, in our example below). Similar to G-computation, the method helps to estimat causal effects more accurately. Here, we consider IPTW in a setting where we wish to estimate the Average Treatment Effect (ATE).</p>
<p>The material seems well written for an advanced biostatistics audience, but I’ll make a few adjustments for improved clarity and precision. Here’s the revised material:</p>
</section>
<section id="inverse-probability-of-treatment-weighting-iptw" class="level2">
<h2 class="anchored" data-anchor-id="inverse-probability-of-treatment-weighting-iptw">Inverse Probability of Treatment Weighting (IPTW)</h2>
<p>Inverse Probability of Treatment Weighting (IPTW) is a method employed for estimating causal effects from observational data. This is achieved by using propensity scores to balance covariates between treated and untreated groups, thereby creating a pseudo-population where the treatment assignment is independent of the observed covariates. This approach, akin to G-computation, aids in enhancing the accuracy of causal effect estimation. In this context, we consider IPTW to estimate the Average Treatment Effect (ATE).</p>
</section>
<section id="bias-in-observational-data-an-example" class="level2">
<h2 class="anchored" data-anchor-id="bias-in-observational-data-an-example">Bias in Observational Data: An Example</h2>
<p>Consider an observational dataset with measures for gender (<code>L</code>), frequency of doctor’s visits (our treatment <code>A</code>), and heart attack incidence (our outcome <code>Y</code>).</p>
<p>Let’s assume:</p>
<ul>
<li>The 10-year incidence risk of heart attacks is <span class="math inline">\(p\)</span> for females.</li>
<li>For males, the risk is <span class="math inline">\(2p\)</span> (twice as high).</li>
<li>Doctor visits reduce the risk of heart attacks by <span class="math inline">\(0.2p\)</span>.</li>
<li>Males are half as likely to visit doctors as females.</li>
</ul>
<p>In our sample of 1,000 individuals:</p>
<ul>
<li>500 are males (50% of 1,000)</li>
<li>500 are females (50% of 1,000)</li>
</ul>
<p>The overall risk <span class="math inline">\(R_{\text{sample}}\)</span> in the sample is computed as the weighted sum of the risks in males and females:</p>
<p><span class="math inline">\(R_{\text{sample}} = 0.5 \times 2p + 0.5 \times p = 1.5p\)</span></p>
<p>Given that the gender proportions are balanced in our sample, <span class="math inline">\(R_{\text{sample}}\)</span> should also represent the true risk <span class="math inline">\(R_{\text{population}}\)</span> in the population:</p>
<p><span class="math inline">\(R_{\text{population}} = R_{\text{sample}} = 1.5p\)</span></p>
<p>However, if we also suppose:</p>
<ul>
<li>Doctor’s visits (the treatment) reduce the risk of a heart attack by <span class="math inline">\(0.25p\)</span>.</li>
<li>Males are twice less likely to visit doctors than females.</li>
</ul>
<p>Under these conditions, the causal effect of treatment on the outcome will be biased.</p>
<p>Let’s assume the baseline risk for females is <span class="math inline">\(0.2\)</span> and for males is <span class="math inline">\(0.4\)</span> (since they are twice as likely to have heart attacks). The treatment effect for individuals who visit a doctor (both males and females) reduces their risk by <span class="math inline">\(0.25p\)</span>.</p>
<p>Hence, we have:</p>
<ul>
<li>Risk of heart attack for females who do not visit the doctor: <span class="math inline">\(0.2\)</span></li>
<li>Risk of heart attack for females who visit the doctor: <span class="math inline">\(0.2 - 0.25 \times 0.2 = 0.15\)</span></li>
<li>Risk of heart attack for males who do not visit the doctor: <span class="math inline">\(0.4\)</span></li>
<li>Risk of heart attack for males who visit the doctor: <span class="math inline">\(0.4 - 0.25 \times 0.4 = 0.3\)</span></li>
</ul>
<p>The bias in the sample is represented in the causal graph <a href="#fig-dag">Figure&nbsp;1</a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dag" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="iptw_files/figure-html/fig-dag-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Causal graph respents how randomisation works. Although being male affects heart attack, the frequency of males in the treatment condition are balanced.</figcaption>
</figure>
</div>
</div>
</div>
<p>Our sample is biased.Now, let’s represent the treatment group (doctor’s visits) and control group (no doctor’s visits) as A = 1 and A = 0, respectively and simulate our data:</p>
<div class="cell" data-warnings="false">
<div class="cell-output-display">
<table class="table table-hover table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Actual_Treatment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">A_1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">A_0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">.25</td>
<td style="text-align: left;">.75</td>
</tr>
<tr class="even">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">.75</td>
<td style="text-align: left;">.25</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="what-is-iptw" class="level2">
<h2 class="anchored" data-anchor-id="what-is-iptw">What is IPTW?</h2>
<p>Inverse Probability of Treatment Weighting (IPTW) is a method for estimating causal effects using <strong>propensity scores</strong> to restore balance in the distribution of confounders within treatment groups. A <strong>propensity score</strong> as the estimated probabilities of receiving treatment given the observed covariates. By balancing the confounding baseline covariates between the treated and untreated groups, we effectively create a pseudo-population where treatment assignment is independent of the observed covariates.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-dag-nobias" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="iptw_files/figure-html/fig-dag-nobias-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Causal graph respents how randomisation works. Although being male affects heart attack, the frequency of males in the treatment condition are balanced.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-warnings="false">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>my_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a> <span class="at">Weighted_Treatment =</span> <span class="fu">c</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a> <span class="st">"Male"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a> <span class="st">"Female"</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a> <span class="at">A_1 =</span> <span class="fu">c</span>(<span class="st">".5"</span>, <span class="st">".5"</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a> <span class="at">A_0 =</span> <span class="fu">c</span>(<span class="st">".5"</span>, <span class="st">".5"</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># create table </span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>my_data <span class="sc">%&gt;%</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a> <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"html"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">kable_styling</span>(<span class="st">"hover"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-hover table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Weighted_Treatment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">A_1</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">A_0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Male</td>
<td style="text-align: left;">.5</td>
<td style="text-align: left;">.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Female</td>
<td style="text-align: left;">.5</td>
<td style="text-align: left;">.5</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Mathematically, the ATE using IPTW can be represented as follows:</p>
<p>[ _{IPTW} = - ]</p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(\hat{ATE}_{IPTW}\)</span> is the estimated Average Treatment Effect using IPTW.</li>
<li><span class="math inline">\(Y_{i}\)</span> is the outcome for individual<span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(A_{i}\)</span> is the treatment status for individual<span class="math inline">\(i\)</span> (1 if treated, 0 if untreated).</li>
<li>( (L_{i}) ) is the estimated propensity score for individual <span class="math inline">\(i\)</span>, which is the predicted probability of treatment given the observed characteristics ( A_{i} ).</li>
</ul>
<p>(Please note that this is the population ATE. If you want the sample ATE, you can replace the sums in the numerator and denominator with means.)</p>
<ol start="3" type="1">
<li><strong>Create Weighted Sample</strong>: In the weighted sample, each individual is given a weight according to their IPTW to create a pseudopopulation</li>
</ol>
<p>After we have the IPTWs for each individual, we can use these weights to create a weighted sample, or pseudopopulation. This pseudopopulation is used to estimate the Average Treatment Effect (ATE).</p>
<p>The weights are used to assign a weight to each individual in the sample. These weights are proportional to the inverse of the probability that the individual received the treatment they did, given their covariates.</p>
<p>The weight for each individual can be viewed as the number of times they appear in the pseudopopulation. For example, if an individual has a weight of 1.25, it is as if they appear 1.25 times in the pseudopopulation.</p>
<p>In a real analysis, we would use this pseudopopulation to estimate the Average Treatment Effect (ATE). We would fit a model (for example, a logistic regression model if the outcome is binary, or a linear regression model if the outcome is continuous) to this weighted sample, and the estimated effect of the treatment would be our estimate of the ATE.</p>
<p>Here we will simulate the <span class="math inline">\(ATE_{IPTW}\)</span> by simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#1. **Treatment assignment:** Treatment assignment must be randomized within each gender group.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#2. **Outcome calculation:** In the calculation of the outcome,the treatment effect should only apply to those who received the treatment.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#3. **IPTW weight calculation:** The weights are  the inverse probability of treatment weights (IPTW), which are used to create a pseudo-population in which treatment assignment is independent of the observed covariates.</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#4. **ATE calculation:** The ATE should be calculated as the difference in the mean outcomes between the treated and untreated groups in the IPTW-adjusted population.</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate data and calculate ATE</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>simulate_ATE <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define groups</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the risks</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  risk_F <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  risk_M <span class="ot">&lt;-</span> <span class="fl">0.6</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  risk_reduction <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a data frame</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>), <span class="at">each =</span> N<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="fu">c</span>(<span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">0.6</span>), <span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">0.2</span>))  <span class="co"># Treatment assignment based on propensity scores</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define outcome based on gender, treatment, and associated risk</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">outcome =</span> <span class="fu">ifelse</span>(gender <span class="sc">==</span> <span class="st">"Female"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">ifelse</span>(treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, risk_F <span class="sc">-</span> risk_reduction), <span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, risk_F)),</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">ifelse</span>(treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, risk_M <span class="sc">-</span> risk_reduction), <span class="fu">rbinom</span>(N<span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span>, risk_M))))</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate propensity scores using logistic regression</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  model_ps <span class="ot">&lt;-</span> <span class="fu">glm</span>(treatment <span class="sc">~</span> gender, <span class="at">data =</span> data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_ps, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate IPTW weights</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">ifelse</span>(treatment <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>ps, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>ps)))</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate ATE using IPTW</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  treated_outcome <span class="ot">&lt;-</span> <span class="fu">with</span>(data, <span class="fu">sum</span>(weight[outcome <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> treatment <span class="sc">==</span> <span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">sum</span>(weight[treatment <span class="sc">==</span> <span class="dv">1</span>]))</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  control_outcome <span class="ot">&lt;-</span> <span class="fu">with</span>(data, <span class="fu">sum</span>(weight[outcome <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> treatment <span class="sc">==</span> <span class="dv">0</span>]) <span class="sc">/</span> <span class="fu">sum</span>(weight[treatment <span class="sc">==</span> <span class="dv">0</span>]))</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  ATE_iptw <span class="ot">&lt;-</span> treated_outcome <span class="sc">-</span> control_outcome</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  ATE_iptw</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Run simulation 500 times</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>simulations <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">500</span>, <span class="fu">simulate_ATE</span>())</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and confidence intervals</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>mean_ATE <span class="ot">&lt;-</span> <span class="fu">mean</span>(simulations)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>CI_ATE <span class="ot">&lt;-</span> <span class="fu">quantile</span>(simulations, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))  <span class="co"># 95% CI</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"95% Confidence Interval for ATE: "</span>, CI_ATE[<span class="dv">1</span>], <span class="st">" - "</span>, CI_ATE[<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "95% Confidence Interval for ATE:  -0.32037215570015  -  -0.18016591005666"</code></pre>
</div>
</div>
<p>This code first defines the gender and treatment status of each individual in the sample. Then it calculates the propensity scores, which are the probabilities of receiving receiving the treatment given the individual’s gender. After that, the code calculates the Inverse Probability of Treatment Weights (IPTWs) for each individual. The IPTWs are then used to calculate the Average Treatment Effect (ATE) using the formula provided above. This simulation is repeated 500 times to estimate the confidence interval for the ATE.</p>
<p>The result of the simulation is a 95% confidence interval for the Average Treatment Effect (ATE). This provides an estimate of the range within which the true ATE is likely to fall, with 95% confidence.</p>
<p>To further clarify the concepts, here is a step-by-step overview of the process:</p>
<ol type="1">
<li><p>Define the population: The population consists of 1,000 individuals, with an equal distribution of males and females.</p></li>
<li><p>Assign treatment: Treatment (doctor’s visits) is assigned based on a Bernoulli distribution, with males being twice as less likely to visit doctors than females.</p></li>
<li><p>Calculate outcomes: The outcome (risk of heart attack) is calculated based on gender and treatment status, with doctor’s visits reducing the risk of heart attacks by 0.25p.</p></li>
<li><p>Estimate propensity scores: Propensity scores, the probability of receiving treatment given the observed covariates, are estimated using a logistic regression model.</p></li>
<li><p>Calculate IPTWs: IPTWs are calculated as the inverse of the propensity scores for the treated, and the inverse of one minus the propensity scores for the untreated.</p></li>
<li><p>Create weighted sample: The IPTWs are used to create a weighted sample, or pseudopopulation, where each individual’s weight is proportional to the inverse of the probability that they received the treatment they did, given their covariates.</p></li>
<li><p>Estimate ATE: The ATE is estimated as the difference in the mean outcomes between the treated and untreated groups in the pseudopopulation. This is done by fitting a model to the weighted sample and estimating the effect of the treatment.</p></li>
</ol>
<p>The last part of the R code block performs a Monte Carlo simulation to repeat this process 500 times. The result is a distribution of ATE estimates, from which we can derive a 95% confidence interval. The confidence interval provides a range of values within which we expect the true ATE to fall, with 95% confidence.</p>
<p>In summary, the IPTW method allows us to estimate causal effects from observational data by addressing the bias due to confounding covariates. In our example, the method helps us estimate the effect of doctor’s visits on heart attack risk, while accounting for gender bias. It’s crucial to note, however, that IPTW only addresses bias due to observed confounders. Any unobserved confounders could still introduce bias into our estimate of the treatment effect.</p>
<p>Finally, it’s important to check the robustness of the IPTW method under different scenarios. Sensitivity analyses can be performed to assess how changes in the assumptions or model specifications could affect the estimated treatment effect. Additionally, other methods like matching or standard regression adjustment could be used in conjunction with IPTW to ensure the robustness of the findings.</p>
<p>Please note that this is a simplified example and in real-world applications, the propensity scores would be estimated using a statistical model such as logistic regression, which could include other covariates. The randomness in the outcome generation and the finite sample size can also result in some variability in the estimated ATE.</p>
<p>This R code provides an example of how to calculate the ATE using IPTW. The ATE using IPTW is the difference between these two quantities.</p>
<p>However, in a real-world scenario, these would be the observed outcomes (in this case, the occurrence of heart attack) for the respective groups. These outcomes would then be used to estimate the ATE using IPTW.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>It’s important to note that IPTW doesn’t adjust for unobserved confounders, and the validity of the results depends on the assumption of no unmeasured confounders, the correct specification of the model used to estimate the propensity scores, and the correct specification of the model used to estimate the ATE.</p>
<p>This example demonstrates the application of IPTW in a relatively simple scenario. In real-world research, we often have to deal with multiple covariates and complex interactions between them, which can further complicate the estimation of propensity scores and IPTWs. Nevertheless, IPTW is a powerful tool for causal inference in observational studies, and it plays a crucial role in many fields of research, including epidemiology, social sciences, and economics.</p>
<p>Sure, let’s refine this text in a step-by-step manner. We’ll provide a precise walkthrough of the steps required for implementing the Inverse Probability of Treatment Weighting (IPTW) and offer a clearer mathematical interpretation of the unweighted ATE using IPTW.</p>
</section>
<section id="step-1-understanding-iptw" class="level2">
<h2 class="anchored" data-anchor-id="step-1-understanding-iptw">Step 1: Understanding IPTW</h2>
<p>Inverse Probability of Treatment Weighting (IPTW) is a method used to estimate causal effects from observational data. This is achieved by balancing the distribution of confounding variables across treatment and control groups using propensity scores.</p>
</section>
<section id="step-2-propensity-scores" class="level2">
<h2 class="anchored" data-anchor-id="step-2-propensity-scores">Step 2: Propensity Scores</h2>
<p>Propensity scores are the predicted probabilities of receiving treatment given the observed covariates. By balancing these confounding covariates, we essentially construct a pseudo-population where the probability of treatment assignment is independent of the observed covariates. This brings us closer to a randomized experiment scenario, enabling us to estimate the causal effect of treatment.</p>
</section>
<section id="step-3-average-treatment-effect-ate" class="level2">
<h2 class="anchored" data-anchor-id="step-3-average-treatment-effect-ate">Step 3: Average Treatment Effect (ATE)</h2>
<p>To apply IPTW, we aim to estimate the Average Treatment Effect (ATE). In its unweighted form, the ATE using IPTW can be represented as:</p>
<p>[ _{IPTW} = - ]</p>
<p>Here:</p>
<ul>
<li><span class="math inline">\(\hat{ATE}_{IPTW}\)</span> represents the estimated Average Treatment Effect using IPTW.</li>
<li><span class="math inline">\(Y_{i}\)</span> represents the outcome for individual <span class="math inline">\(i\)</span>.</li>
<li><span class="math inline">\(A_{i}\)</span> is the treatment status for individual <span class="math inline">\(i\)</span> (1 if treated, 0 if untreated).</li>
<li><span class="math inline">\(\hat{e}(L_{i})\)</span> denotes the estimated propensity score for individual <span class="math inline">\(i\)</span>, which is the predicted probability of treatment given the observed characteristics <span class="math inline">\(L_{i}\)</span>.</li>
</ul>
<p>The above formula calculates the difference in outcomes between the treated and untreated individuals, where each individual’s contribution is weighted by the inverse of their probability of receiving the treatment they did, given their covariates. This creates an unweighted or crude estimate of the ATE, as it doesn’t account for potential bias due to confounding covariates.</p>
</section>
<section id="step-4-creating-a-weighted-sample" class="level2">
<h2 class="anchored" data-anchor-id="step-4-creating-a-weighted-sample">Step 4: Creating a Weighted Sample</h2>
<p>After calculating the IPTWs for each individual, we can use these weights to construct a weighted sample, or pseudopopulation. This pseudopopulation is used to estimate the ATE.</p>
<p>The weights are used to assign a value to each individual in the sample. These weights are proportional to the inverse of the probability that the individual received the treatment they did, given their covariates.</p>
<p>In the context of the pseudopopulation, the weight for each individual can be thought of as the number of times they appear in the pseudopopulation. For instance, if an individual has a weight of 1.25, it is as if they appear 1.25 times in the pseudopopulation.</p>
</section>
<section id="step-5-estimating-the-ate" class="level2">
<h2 class="anchored" data-anchor-id="step-5-estimating-the-ate">Step 5: Estimating the ATE</h2>
<p>In practical analysis, we use this pseudopopulation to estimate the ATE. We fit a model (for example, a logistic regression model if the outcome is binary, or a linear regression model if the outcome is continuous) to this weighted sample, and the estimated effect of the Sure, let’s continue from where we left off:</p>
</section>
<section id="step-5-estimating-the-ate-continued" class="level2">
<h2 class="anchored" data-anchor-id="step-5-estimating-the-ate-continued">Step 5: Estimating the ATE (Continued)</h2>
<p>treatment serves as our estimate of the ATE. When done correctly, this approach can help us estimate the causal effect of the treatment, while accounting for the confounding variables that could otherwise bias our results.</p>
</section>
<section id="step-6-simulation" class="level2">
<h2 class="anchored" data-anchor-id="step-6-simulation">Step 6: Simulation</h2>
<p>The next step involves simulating the <span class="math inline">\(ATE_{IPTW}\)</span> to estimate the confidence interval for the ATE. This simulation is usually performed multiple times (say, 500 times) to generate a distribution of ATE estimates, which is used to calculate a confidence interval for the true ATE. This confidence interval provides a range within which we would expect the true ATE to fall with a certain level of confidence, typically 95%.</p>
</section>
<section id="step-7-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="step-7-interpretation">Step 7: Interpretation</h2>
<p>After the simulation, we interpret the results. The IPTW approach allows us to estimate the causal effects from observational data by addressing the bias due to confounding covariates. It’s important to note, however, that the IPTW approach only adjusts for observed confounders; unobserved confounders could still introduce bias into our estimates.</p>
</section>
<section id="step-8-validation" class="level2">
<h2 class="anchored" data-anchor-id="step-8-validation">Step 8: Validation</h2>
<p>Finally, it’s crucial to validate the findings. Sensitivity analyses can be conducted to assess how changes in the assumptions or model specifications could affect the estimated treatment effect. Also, other methods like matching or standard regression adjustment could be used alongside IPTW to ensure the robustness of the findings.</p>
<p>Remember, this is a simplified example. In real-world applications, propensity scores would typically be estimated using more complex statistical models, potentially including a variety of other covariates. Also, the randomness in the outcome generation and finite sample sizes can introduce variability in the estimated ATE.</p>
</section>
<section id="summary-1" class="level2">
<h2 class="anchored" data-anchor-id="summary-1">Summary</h2>
<p>IPTW is a powerful tool for estimating causal effects from observational data, particularly when random assignment to treatment and control groups is not feasible. However, it’s important to be aware of its limitations. The method doesn’t adjust for unobserved confounders, and the validity of the results depends on the assumption of no unmeasured confounders, correct specification of the propensity score model, and correct specification of the model used to estimate the ATE. Despite these challenges, when applied correctly, IPTW can provide valuable insights in fields as diverse as epidemiology, economics, and social sciences.</p>
<section id="looking-ahead" class="level3">
<h3 class="anchored" data-anchor-id="looking-ahead">Looking ahead</h3>
</section>
</section>
<section id="iptw-with-time-varying-treatments" class="level2">
<h2 class="anchored" data-anchor-id="iptw-with-time-varying-treatments">IPTW with Time-varying Treatments</h2>
<p>In longitudinal studies, where treatments can vary over time, we can extend the IPTW method to handle time-varying treatments. For this, we use a concept called the “marginal structural model”. In this model, we estimate the effect of the treatment over time, accounting for the fact that the treatment and covariates can change over time.</p>
<p>The weights in this case, often referred to as “stabilized weights”, are calculated slightly differently than in the simple IPTW method. They are designed to reduce the variability of the weights and improve the efficiency of the estimator.</p>
<section id="checking-the-balance-of-covariates" class="level3">
<h3 class="anchored" data-anchor-id="checking-the-balance-of-covariates">Checking the Balance of Covariates</h3>
<p>After calculating the IPTWs and creating the pseudopopulation, it’s important to check the balance of covariates between the treated and untreated groups. This can be done by comparing the distribution of covariates in the treated and untreated groups before and after weighting. If the IPTW method is successful, the distributions of the covariates should be similar in the two groups after weighting.</p>
</section>
<section id="variance-estimation" class="level3">
<h3 class="anchored" data-anchor-id="variance-estimation">Variance Estimation</h3>
<p>Standard errors and confidence intervals for the ATE estimator using IPTW can be obtained using bootstrapping, a resampling method that provides an empirical estimation of the sampling distribution of a statistic. Alternatively, robust variance estimators can be used.</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>While IPTW is a powerful tool for causal inference, it is not without its challenges. It requires correct specification of the treatment model (to estimate propensity scores) and careful interpretation of the results. Further, it only addresses confounding by observed covariates, and unobserved confounding remains a potential source of bias. Despite these challenges, IPTW remains a valuable method in observational studies where randomized controlled trials are not feasible.</p>
<p>In practice, IPTW is often used in combination with other methods for causal inference, such as matching or stratification on the propensity score, or doubly robust estimators which combine propensity score methods and outcome regression. Each method has its strengths and limitations, and the choice between methods will depend on the specific research question and the data at hand.</p>
<p>Moreover, it is crucial to perform diagnostics checks, such as checking for overlap in the propensity scores (common support) and balance of covariates after weighting. Also, sensitivity analyses can be done to assess the robustness of the results to potential unmeasured confounding.</p>
<p>Finally, the ultimatfe goal is to ensure that the conclusions drawn from observational data about causal effects are as valid and robust as possible. It is in this endeavor that methods like IPTW play a crucial role.</p>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA</div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{bulbulia2023,
  author = {Bulbulia, Joseph},
  title = {Inverse {Probability} of {Treatment} {Weighting:} {A}
    {Practical} {Guide}},
  date = {2023-05-11},
  url = {https://go-bayes.github.io/b-causal/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-bulbulia2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Bulbulia, Joseph. 2023. <span>“Inverse Probability of Treatment
Weighting: A Practical Guide.”</span> May 11, 2023. <a href="https://go-bayes.github.io/b-causal/">https://go-bayes.github.io/b-causal/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>